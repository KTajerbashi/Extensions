@page "/caching-in-sql"
@rendermode InteractiveServer

@using CachingApp.Models
@using CachingApp.Repository
@using Extensions.Caching.Abstractions

@inject ICacheAdapter Cache
@inject ILogger<CachingInSQL> Logger
@inject ICacheInspector Inspector

<h3 class="mb-3">SQL Distributed Caching Demo</h3>

<!-- Add to Cache -->
<div class="card p-3 shadow-sm">

    <h5>Add Item to Cache</h5>
    <div class="mb-2">
        <label>Key:</label>
        <input class="form-control" @bind="CacheKey" />
    </div>

    <div class="mb-2">
        <label>Value:</label>
        <textarea class="form-control" rows="3" @bind="CacheValue"></textarea>
    </div>

    <div class="row">
        <div class="col">
            <label>Absolute Expiration (minutes)</label>
            <input type="number" class="form-control" @bind="AbsoluteExpirationMinutes" />
        </div>
        <div class="col">
            <label>Sliding Expiration (minutes)</label>
            <input type="number" class="form-control" @bind="SlidingExpirationMinutes" />
        </div>
    </div>

    <button class="btn btn-primary mt-3" @onclick="AddToCache">Add to Cache</button>
</div>

@if (!string.IsNullOrWhiteSpace(Message))
{
    <div class="alert alert-info mt-3">@Message</div>
}

<hr />

<!-- CACHE TABLE -->
<div class="card shadow-sm p-3 mt-4">
    <div class="d-flex justify-content-between align-items-center">
        <h5>Cache Records</h5>

        <div>
            <button class="btn btn-outline-secondary btn-sm" @onclick="LoadAllCache">Refresh</button>
        </div>
    </div>

    <div class="my-3">
        <button class="btn btn-sm @(Filter == "all" ? "btn-primary" : "btn-outline-primary")" @onclick="@(() => ChangeFilter("all"))">All</button>
        <button class="btn btn-sm ms-2 @(Filter == "active" ? "btn-success" : "btn-outline-success")" @onclick="@(() => ChangeFilter("active"))">Active</button>
        <button class="btn btn-sm ms-2 @(Filter == "expired" ? "btn-danger" : "btn-outline-danger")" @onclick="@(() => ChangeFilter("expired"))">Expired</button>
    </div>

    <table class="table table-striped">
        <thead>
            <tr>
                <th>Key</th>
                <th>Value</th>
                <th>ExpiresAtTime</th>
                <th>Sliding</th>
                <th>Absolute</th>
                <th>Status</th>
            </tr>
        </thead>
        <tbody>
            @if (FilteredCache?.Count == 0)
            {
                <tr><td colspan="6" class="text-center text-muted">No data found.</td></tr>
            }
            else
            {
                @foreach (var item in FilteredCache)
                {
                    <tr>
                        <td>@item.Key</td>
                        <td><pre>@item.Value</pre></td>
                        <td>@item.ExpiresAtTime</td>
                        <td>@item.SlidingExpirationInSeconds</td>
                        <td>@item.AbsoluteExpiration</td>
                        <td>
                            @if (item.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-danger">Expired</span>
                            }
                        </td>
                    </tr>
                }
            }
        </tbody>
    </table>
</div>

<hr />

<!-- REMOVE -->
<div class="card p-3 shadow-sm mt-4">
    <h5>Remove Cache Item</h5>
    <div class="input-group">
        <input class="form-control" @bind="RemoveKey" />
        <button class="btn btn-danger" @onclick="RemoveFromCache">Remove</button>
    </div>
</div>

@code {

    private string CacheKey { get; set; }
    private string CacheValue { get; set; }
    private int? AbsoluteExpirationMinutes { get; set; }
    private int? SlidingExpirationMinutes { get; set; }

    private string RemoveKey { get; set; }
    private string Message { get; set; }

    private List<CacheRecord> AllCache = new();
    private List<CacheRecord> FilteredCache = new();
    private string Filter = "all";

    protected override async Task OnInitializedAsync()
    {
        await LoadAllCache();
    }

    private void ChangeFilter(string value)
    {
        Filter = value;
        ApplyFilter();
    }

    private async Task LoadAllCache()
    {
        AllCache = Inspector.GetAll();
        ApplyFilter();
    }

    private void ApplyFilter()
    {
        FilteredCache = Filter switch
        {
            "active" => AllCache.Where(x => x.IsActive).ToList(),
            "expired" => AllCache.Where(x => !x.IsActive).ToList(),
            _ => AllCache
        };
    }

    private async Task AddToCache()
    {
        DateTime? abs = AbsoluteExpirationMinutes.HasValue ? DateTime.Now.AddMinutes(AbsoluteExpirationMinutes.Value) : null;
        TimeSpan? sliding = SlidingExpirationMinutes.HasValue ? TimeSpan.FromMinutes(SlidingExpirationMinutes.Value) : null;

        Cache.Add(CacheKey, CacheValue, abs, sliding);

        Message = $"Key '{CacheKey}' added.";
        await LoadAllCache();
    }

    private async Task RemoveFromCache()
    {
        Cache.RemoveCache(RemoveKey);
        Message = $"Key '{RemoveKey}' removed.";
        await LoadAllCache();
    }
}
